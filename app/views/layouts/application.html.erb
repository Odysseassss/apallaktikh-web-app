<!DOCTYPE html>
<html>
  <head>
    <title><%= content_for(:title) || "Ergasia 2025 2026 Thema1" %></title>
    <meta name="viewport" content="width=device-width,initial-scale=1">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="application-name" content="Ergasia 2025 2026 Thema1">
    <meta name="mobile-web-app-capable" content="yes">
    <%= csrf_meta_tags %>
    <%= csp_meta_tag %>

    <%= yield :head %>

    <link rel="icon" href="/icon.png" type="image/png">
    <link rel="icon" href="/icon.svg" type="image/svg+xml">
    <link rel="apple-touch-icon" href="/icon.png">
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/@picocss/pico@2/css/pico.min.css">
    <%= stylesheet_link_tag :app, "data-turbo-track": "reload" %>
    <%= javascript_importmap_tags %>
  </head>

  <body>
    <nav class="container-fluid" style="padding: 0 40px; border-bottom: 1px solid #FFFFFF22;">
          <ul>
              <li>
                <%= link_to root_path, style: "text-decoration: none;" do %>
                  <h2 style="margin: 0; color: #0081c9; font-weight: bold;font-family: 'Montserrat', sans-serif;">Our portal</h2>
                <% end %>
              </li>
          </ul>
          <ul>
            <% if user_signed_in? %>
              <li><small>Hello, <%= current_user.name %> !</small></li>
              <li><%= link_to "Profile", user_profile_path %></li>
              <li>
                <%= button_to "Sign Out", destroy_user_session_path, method: :delete, class: "outline", style: "display: inline; width: auto; margin: 0; padding: 5px 10px;" %>
              </li>
            <% else %>
              <li><%= link_to "Log In", new_user_session_path %></li>
              <li><%= link_to "Sign Up", new_user_registration_path, role: "button" %></li>
            <% end %>
          </ul>
    </nav>

    <% if user_signed_in? %>
  <div style="position: fixed; top: 15px; left: 250px; z-index: 999;">
    <button onclick="toggleContacts()" style="background-color: #0081c9; border: none; padding: 10px 20px; border-radius: 4px; font-weight: bold; cursor: pointer; box-shadow: 2px 2px 10px rgba(0,0,0,0.3);">
    	Contacts 
      <% req_count = current_user.received_requests.where(status: 'pending').count %>
      <% if req_count > 0 %>
        <span style="background: #dc3545; color: white; border-radius: 50%; padding: 2px 7px; font-size: 12px; margin-left: 5px;"><%= req_count %></span>
      <% end %>
    </button>
  </div>
  <div style="position: fixed; top: 15px; left: 420px; z-index: 999;">
    <button style="background-color: #0081c9; border: none; padding: 10px 20px; border-radius: 4px; font-weight: bold; cursor: pointer; box-shadow: 2px 2px 10px rgba(0,0,0,0.3);">
    	Chat 
    </button>
  </div>

  <div id="contactsSidePanel" style="position: fixed; top: 0; left: -400px; width: 380px; height: 100%; background: #1a1e22; z-index: 1001; transition: 0.3s; box-shadow: 5px 0 15px rgba(0,0,0,0.5); display: flex; flex-direction: column; border-right: 1px solid #444;">
    
    <div style="padding: 20px; background: #212529; display: flex; justify-content: space-between; align-items: center; border-bottom: 1px solid #444;">
      <h3 style="margin: 0; color: white; font-size: 1.3rem;">Contacts&Requests</h3>
      <button onclick="toggleContacts()" style="background: none; border: none; color: #aaa; font-size: 28px; cursor: pointer;">&times;</button>
    </div>

    <div style="padding: 20px; overflow-y: auto; flex-grow: 1;">
      
      <h4 style="color: #0081c9; font-size: 1rem; border-bottom: 1px solid #333; padding-bottom: 5px;">New Requests</h4>
      <% pending = current_user.received_requests.where(status: 'pending') %>
      <% if pending.any? %>
        <% pending.each do |req| %>
          <div style="background: #2c3035; padding: 10px; border-radius: 6px; margin-bottom: 10px;">
            <div style="font-size: 0.85rem; margin-bottom: 8px;"><%= req.user.email %></div>
            <div style="display: flex; gap: 5px;">
              <%= link_to "Αποδοχή", contact_path(req), data: { turbo_method: :patch }, style: "background: #198754; color: white; padding: 4px 10px; border-radius: 4px; text-decoration: none; font-size: 0.8rem; flex: 1; text-align: center;" %>
              <%= link_to "✖", contact_path(req), data: { turbo_method: :delete }, style: "background: #dc3545; color: white; padding: 4px 10px; border-radius: 4px; text-decoration: none; font-size: 0.8rem;" %>
            </div>
          </div>
        <% end %>
      <% else %>
        <p style="color: #666; font-style: italic; font-size: 0.9rem;">No requests here</p>
      <% end %>

      <br>

      <h4 style="color: #0081c9; font-size: 1rem; border-bottom: 1px solid #333; padding-bottom: 5px;">My contacts</h4>
      <% friends = Contact.where(user: current_user, status: 'accepted') %>
      <% if friends.any? %>
        <% friends.each do |c| %>
          <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 10px; padding: 5px 0;">
            <span style="font-size: 0.9rem;"><%= c.friend.name %></span>
			<%= link_to chatrooms_path(user_id: c.friend_id), 
				  data: { turbo_method: :post }, 
				  style: "color: #198754; font-size: 0.75rem; text-decoration: none; font-weight: bold; display: flex; align-items: center; gap: 4px;" do %>
				  <svg width="12" height="12" fill="currentColor" viewBox="0 0 16 16">
					  <path d="M14 1a1 1 0 0 1 1 1v8a1 1 0 0 1-1 1H4.414L1 14.414V2a1 1 0 0 1 1-1h12zM2 0a2 2 0 0 0-2 2v12.793a.5.5 0 0 0 .854.353l2.853-2.853A1 1 0 0 1 4.414 12H14a2 2 0 0 0 2-2V2a2 2 0 0 0-2-2H2z"/>
				  </svg>
					Chat
			<% end %>
            <%= link_to "Delete", contact_path(c), data: { turbo_method: :delete }, style: "color: #ff6b6b; font-size: 0.75rem; text-decoration: none;" %>
          </div>
        <% end %>
      <% else %>
        <p style="color: #666; font-style: italic; font-size: 0.9rem;">No contacts here</p>
      <% end %>
    </div>
  </div>

  <div id="panelOverlay" onclick="toggleContacts()" style="position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.5); z-index: 1000; display: none;"></div>

  <script>
    function toggleContacts() {
      const panel = document.getElementById('contactsSidePanel');
      const overlay = document.getElementById('panelOverlay');
      if (panel.style.left === '0px') {
        panel.style.left = '-400px';
        overlay.style.display = 'none';
      } else {
        panel.style.left = '0px';
        overlay.style.display = 'block';
      }
    }
  </script>
<% end %>

    <main style="width: 100%; max-width: 1400px; margin: 0 auto; padding: 20px;">
        <%= yield %>
    </main>

  </body>
</html>